#!/command/with-contenv sh
# shellcheck shell=sh

set -e

# ==============================================================================
# S6-Overlay service run script for the Readeck Addon
# ==============================================================================

# Import shell functions from Home Assistant base image.
# source /usr/lib/hassio-addons/base.sh

# Set default Readeck environment variables.
# Using 8001 to match the 'ports' section in config.yaml.
: "${READECK_SERVER_HOST:=0.0.0.0}"
: "${READECK_SERVER_PORT:=8001}"

export READECK_SERVER_HOST
export READECK_SERVER_PORT

# ------------------------------------------------------------------------------
# Optional: Parse options.json for advanced configuration.
# ------------------------------------------------------------------------------
# If you want to use the configuration options (allowed_hosts, etc.)
# from the Home Assistant UI, you need to:
#   1. Add 'jq' to your Dockerfile (`apk add --no-cache jq`).
#   2. Determine which environment variables Readeck uses for these settings.
#   3. Uncomment and adapt the code below.
#
# HASS_ALLOWED_HOSTS=$(hass.config.get 'allowed_hosts | join(",")')
# HASS_USE_X_FORWARDED_FOR=$(hass.config.get 'use_x_forwarded_for')
# HASS_USE_X_FORWARDED_HOST=$(hass.config.get 'use_x_forwarded_host')
# HASS_USE_X_FORWARDED_PROTO=$(hass.config.get 'use_x_forwarded_proto')
#
# Example (replace READECK_VAR_NAME with actual env var names):
# export READECK_ALLOWED_HOSTS="${HASS_ALLOWED_HOSTS}"
# export READECK_USE_X_FORWARDED_FOR="${HASS_USE_X_FORWARDED_FOR}"
# ------------------------------------------------------------------------------

# Start Readeck application.
echo "Starting Readeck server on ${READECK_SERVER_HOST}:${READECK_SERVER_PORT}..."
exec /bin/readeck serve